<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel &mdash; Chatting Wizard School</title>
  <link rel="icon" type="image/png" href="logo.png">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="auth.js"></script>
</head>
<body>
<div class="admin-page">

  <!-- Header -->
  <div class="admin-header">
    <div class="admin-header-left">
      <img src="logo.png" alt="CW" class="admin-logo">
      <h1>Admin Panel</h1>
    </div>
    <div class="admin-header-right">
      <a href="index.html" class="admin-back-link">&larr; Back to School</a>
      <button onclick="cwSignOut()" class="logout-btn">Log Out</button>
    </div>
  </div>

  <!-- Loading -->
  <div id="admin-loading" class="admin-loading">Loading admin data...</div>

  <!-- Stats -->
  <div id="admin-stats" class="admin-stats" style="display:none;">
    <div class="admin-stat-card">
      <div class="admin-stat-value" id="statStudents">0</div>
      <div class="admin-stat-label">Students</div>
    </div>
    <div class="admin-stat-card">
      <div class="admin-stat-value" id="statCompleted">0</div>
      <div class="admin-stat-label">Completed School</div>
    </div>
    <div class="admin-stat-card">
      <div class="admin-stat-value" id="statAvgScore">0%</div>
      <div class="admin-stat-label">Avg Final Quiz</div>
    </div>
    <div class="admin-stat-card">
      <div class="admin-stat-value" id="statInvites">0</div>
      <div class="admin-stat-label">Unused Invites</div>
    </div>
  </div>

  <!-- Invite Codes Section -->
  <div id="admin-invites" class="admin-section" style="display:none;">
    <div class="admin-section-header">
      <h2>Invite Codes</h2>
      <button onclick="generateCode()" class="admin-btn" id="genBtn">Generate New Code</button>
    </div>
    <div id="newCodeMsg" class="admin-code-msg" style="display:none;"></div>
    <table class="admin-table" id="inviteTable">
      <thead>
        <tr><th>Code</th><th>Status</th><th>Used By</th><th>Created</th></tr>
      </thead>
      <tbody id="inviteBody"></tbody>
    </table>
  </div>

  <!-- Students Section -->
  <div id="admin-students" class="admin-section" style="display:none;">
    <h2>Students</h2>
    <table class="admin-table">
      <thead>
        <tr><th>Name</th><th>Email</th><th>Role</th><th>Registered</th><th>Modules</th><th>Quizzes</th><th>Actions</th></tr>
      </thead>
      <tbody id="studentBody"></tbody>
    </table>
  </div>

  <!-- Student Detail / Edit Modal -->
  <div id="studentDetail" class="admin-detail" style="display:none;">
    <div class="admin-detail-card">
      <div class="admin-detail-header">
        <h3 id="detailTitle">Student Details</h3>
        <button onclick="closeDetail()" class="admin-close">&times;</button>
      </div>

      <!-- Edit Section -->
      <div class="admin-edit-section">
        <h4>&#9998; Edit Student</h4>
        <div class="admin-edit-row">
          <label>Name</label>
          <input type="text" id="editName" class="admin-input" placeholder="Full name">
        </div>
        <div class="admin-edit-row">
          <label>Role</label>
          <select id="editRole" class="admin-input">
            <option value="student">Student</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="admin-edit-actions">
          <button onclick="saveStudentEdit()" class="admin-btn" id="saveEditBtn">Save Changes</button>
          <span id="editFeedback" class="admin-feedback"></span>
        </div>
      </div>

      <!-- Section Access Control -->
      <div class="admin-access-section">
        <h4>&#128275; Section Access</h4>
        <p class="admin-access-note">Toggle sections on/off for this student. Overrides quiz gating.</p>
        <div class="admin-access-grid" id="accessGrid"></div>
      </div>

      <!-- Danger Zone -->
      <div class="admin-danger-section">
        <h4>&#9888; Actions</h4>
        <div class="admin-danger-actions">
          <button onclick="resetStudentQuizzes()" class="admin-btn-danger" id="resetQuizBtn">Reset All Quizzes</button>
          <button onclick="resetStudentProgress()" class="admin-btn-danger" id="resetProgressBtn">Reset All Progress</button>
        </div>
        <p class="admin-danger-note">These actions cannot be undone. The student will need to redo quizzes and re-check modules.</p>
      </div>

      <!-- Quiz Results -->
      <h4>&#128202; Quiz Results</h4>
      <table class="admin-table">
        <thead><tr><th>Module</th><th>Score</th><th>Passed</th><th>Date</th></tr></thead>
        <tbody id="detailQuizzes"></tbody>
      </table>

      <!-- Completed Modules -->
      <h4>&#9989; Completed Modules</h4>
      <div id="detailModules" class="admin-module-list"></div>

      <!-- Student Info -->
      <p id="detailEmail" class="admin-detail-email"></p>
    </div>
  </div>

</div>

<script>
var allStudents = [];
var allInvites = [];
var currentDetailIdx = -1;

var MODULE_NAMES = {
  'f-1':'Welcome + 3 Key Words','f-2':'Who is CW + Team','f-3':'OnlyFans + Money','f-4':'Your Role + Shift','f-5':'Banned Topics','f-6':'Foundations Review',
  't-1':'Foundations Review Quiz','t-2':'Infloww Walkthrough','t-3':'Scripts 101','t-4':'Model Personas','t-5':'Journey + PPV Ladder','t-6':'48-Hour Rule',
  'j-1':'Tools Review Quiz','j-2':'Rapport + Teasing','j-3':'Sexting + PPV','j-4':'Aftercare','j-5':'Branch Rules + NR','j-6':'Fan Assessment','j-7':'Annotated Chats',
  'a-1':'Journey Review Quiz','a-2':'Objection Scripts','a-3':'Customs (TPDs)','a-4':'Multitasking','a-5':'Shift Routine','a-6':'Common Mistakes','a-7':'Full Simulation',
  'g-1':'Advanced Review Quiz','g-2':'Final Quiz','g-3':'Supervised Shift'
};

var SECTIONS = [
  { id: 'foundations', label: 'Foundations', gated: false },
  { id: 'tools', label: 'Tools & Scripts', gated: true },
  { id: 'journey', label: 'The Journey', gated: true },
  { id: 'advanced', label: 'Advanced Skills', gated: true },
  { id: 'golive', label: 'Go Live', gated: true }
];

(async function initAdmin() {
  try {
    var user = await getUser();
    if (!user) { window.location.href = 'login.html'; return; }
    var profile = await getUserProfile(user.id);
    if (!profile || profile.role !== 'admin') {
      alert('Access denied. Admin only.');
      window.location.href = 'index.html';
      return;
    }

    await loadAllData();

    document.getElementById('admin-loading').style.display = 'none';
    document.getElementById('admin-stats').style.display = '';
    document.getElementById('admin-invites').style.display = '';
    document.getElementById('admin-students').style.display = '';
  } catch(err) {
    document.getElementById('admin-loading').textContent = 'Error: ' + (err.message || 'Could not load admin data.');
  }
})();

async function loadAllData() {
  var results = await Promise.all([
    adminGetStudents(),
    adminGetInviteCodes()
  ]);
  allStudents = results[0] || [];
  allInvites = results[1] || [];
  renderStats();
  renderInvites();
  renderStudents();
}

// ============ Stats ============
function renderStats() {
  document.getElementById('statStudents').textContent = allStudents.length;
  var completed = allStudents.filter(function(s) {
    return s.quiz_results && s.quiz_results.some(function(q) { return q.module_id === 'g-2' && q.passed; });
  });
  document.getElementById('statCompleted').textContent = completed.length;

  var finalScores = allStudents.map(function(s) {
    if (!s.quiz_results) return null;
    var f = s.quiz_results.find(function(q) { return q.module_id === 'g-2'; });
    return f ? f.percentage : null;
  }).filter(function(x) { return x !== null; });

  var avg = finalScores.length > 0 ? Math.round(finalScores.reduce(function(a,b){return a+b;},0) / finalScores.length) : 0;
  document.getElementById('statAvgScore').textContent = avg + '%';

  var unused = allInvites.filter(function(c) { return !c.used_by; });
  document.getElementById('statInvites').textContent = unused.length;
}

// ============ Invite Codes ============
function renderInvites() {
  var body = document.getElementById('inviteBody');
  body.innerHTML = '';
  allInvites.forEach(function(inv) {
    var tr = document.createElement('tr');
    var status = inv.used_by ? 'Used' : 'Available';
    var statusClass = inv.used_by ? 'admin-tag-used' : 'admin-tag-available';
    var usedBy = '';
    if (inv.used_by) {
      var student = allStudents.find(function(s) { return s.id === inv.used_by; });
      usedBy = student ? (student.full_name || student.email) : inv.used_by;
    }
    tr.innerHTML = '<td><code>' + inv.code + '</code></td>' +
      '<td><span class="admin-tag ' + statusClass + '">' + status + '</span></td>' +
      '<td>' + usedBy + '</td>' +
      '<td>' + new Date(inv.created_at).toLocaleDateString() + '</td>';
    body.appendChild(tr);
  });
  if (allInvites.length === 0) {
    body.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#9ca3af;">No invite codes yet.</td></tr>';
  }
}

// ============ Students Table ============
function renderStudents() {
  var body = document.getElementById('studentBody');
  body.innerHTML = '';
  allStudents.forEach(function(s, idx) {
    var tr = document.createElement('tr');
    var modules = s.modules_completed || 0;
    var quizzes = s.quizzes_passed || 0;
    var roleClass = s.role === 'admin' ? 'admin-tag-admin' : 'admin-tag-available';
    var roleLabel = s.role === 'admin' ? 'Admin' : 'Student';
    tr.innerHTML = '<td>' + (s.full_name || '(no name)') + '</td>' +
      '<td>' + s.email + '</td>' +
      '<td><span class="admin-tag ' + roleClass + '">' + roleLabel + '</span></td>' +
      '<td>' + new Date(s.created_at).toLocaleDateString() + '</td>' +
      '<td>' + modules + '</td>' +
      '<td>' + quizzes + '</td>' +
      '<td><button class="admin-btn-sm" onclick="showDetail(' + idx + ')">Manage</button></td>';
    body.appendChild(tr);
  });
  if (allStudents.length === 0) {
    body.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#9ca3af;">No students registered yet.</td></tr>';
  }
}

// ============ Student Detail / Edit Modal ============
function showDetail(idx) {
  currentDetailIdx = idx;
  var s = allStudents[idx];

  document.getElementById('detailTitle').textContent = s.full_name || s.email;
  document.getElementById('detailEmail').textContent = s.email + ' — ID: ' + s.id + ' — Registered ' + new Date(s.created_at).toLocaleDateString();

  // Populate edit fields
  document.getElementById('editName').value = s.full_name || '';
  document.getElementById('editRole').value = s.role || 'student';
  document.getElementById('editFeedback').textContent = '';

  // Quiz results
  var qBody = document.getElementById('detailQuizzes');
  qBody.innerHTML = '';
  if (s.quiz_results && s.quiz_results.length > 0) {
    // Sort by section order
    var sorted = s.quiz_results.slice().sort(function(a, b) {
      return (a.module_id || '').localeCompare(b.module_id || '');
    });
    sorted.forEach(function(q) {
      var tr = document.createElement('tr');
      var passClass = q.passed ? 'admin-tag-available' : 'admin-tag-used';
      tr.innerHTML = '<td>' + (MODULE_NAMES[q.module_id] || q.module_id) + '</td>' +
        '<td>' + q.score + ' (' + q.percentage + '%)</td>' +
        '<td><span class="admin-tag ' + passClass + '">' + (q.passed ? 'Passed' : 'Failed') + '</span></td>' +
        '<td>' + new Date(q.submitted_at).toLocaleDateString() + '</td>';
      qBody.appendChild(tr);
    });
  } else {
    qBody.innerHTML = '<tr><td colspan="4" style="color:#9ca3af;">No quizzes taken yet</td></tr>';
  }

  // Completed modules
  var mDiv = document.getElementById('detailModules');
  if (s.completed_modules && s.completed_modules.length > 0) {
    var sorted = s.completed_modules.slice().sort();
    mDiv.innerHTML = sorted.map(function(m) {
      return '<span class="admin-module-badge">' + (MODULE_NAMES[m] || m) + '</span>';
    }).join(' ');
  } else {
    mDiv.innerHTML = '<span style="color:#9ca3af;">No modules completed yet</span>';
  }

  // Section access toggles
  renderAccessGrid(s);

  document.getElementById('studentDetail').style.display = '';
}

function renderAccessGrid(student) {
  var grid = document.getElementById('accessGrid');
  var unlocks = student.unlocked_sections || [];
  var gates = { tools: 't-1', journey: 'j-1', advanced: 'a-1', golive: 'g-1' };

  grid.innerHTML = '';
  SECTIONS.forEach(function(sec) {
    if (!sec.gated) return; // Foundations always open, no toggle needed

    var gateQuiz = gates[sec.id];
    var passedQuiz = student.quiz_results && student.quiz_results.some(function(q) {
      return q.module_id === gateQuiz && q.passed;
    });
    var manuallyUnlocked = unlocks.indexOf(sec.id) >= 0;
    var isOpen = passedQuiz || manuallyUnlocked;

    var card = document.createElement('div');
    card.className = 'admin-access-card ' + (isOpen ? 'access-open' : 'access-locked');

    var statusLabel = '';
    if (passedQuiz) statusLabel = '<span class="admin-tag admin-tag-available">Quiz passed</span>';
    else if (manuallyUnlocked) statusLabel = '<span class="admin-tag admin-tag-manual">Manual</span>';
    else statusLabel = '<span class="admin-tag admin-tag-used">Locked</span>';

    card.innerHTML =
      '<div class="access-card-top">' +
        '<strong>' + sec.label + '</strong>' +
        statusLabel +
      '</div>' +
      '<label class="access-toggle">' +
        '<input type="checkbox" ' + (manuallyUnlocked ? 'checked' : '') + ' ' +
          (passedQuiz ? 'disabled title="Already passed via quiz"' : '') +
          ' onchange="toggleSection(\'' + student.id + '\', \'' + sec.id + '\', this.checked)">' +
        '<span class="access-toggle-label">' + (passedQuiz ? 'Earned via quiz' : 'Grant manual access') + '</span>' +
      '</label>';

    grid.appendChild(card);
  });
}

async function toggleSection(studentId, sectionId, grant) {
  try {
    if (grant) {
      await adminGrantSection(studentId, sectionId);
    } else {
      await adminRevokeSection(studentId, sectionId);
    }
    // Refresh data and re-render
    await loadAllData();
    if (currentDetailIdx >= 0) {
      renderAccessGrid(allStudents[currentDetailIdx]);
    }
  } catch(err) {
    alert('Error: ' + (err.message || 'Could not update access.'));
    // Refresh to revert toggle state
    await loadAllData();
    if (currentDetailIdx >= 0) renderAccessGrid(allStudents[currentDetailIdx]);
  }
}

function closeDetail() {
  document.getElementById('studentDetail').style.display = 'none';
  currentDetailIdx = -1;
}

// ============ Save Edits ============
async function saveStudentEdit() {
  if (currentDetailIdx < 0) return;
  var s = allStudents[currentDetailIdx];
  var btn = document.getElementById('saveEditBtn');
  var feedback = document.getElementById('editFeedback');
  var newName = document.getElementById('editName').value.trim();
  var newRole = document.getElementById('editRole').value;

  btn.disabled = true;
  btn.textContent = 'Saving...';
  feedback.textContent = '';

  try {
    await adminUpdateStudent(s.id, newName, newRole);
    feedback.textContent = 'Saved!';
    feedback.className = 'admin-feedback admin-feedback-ok';

    // Refresh data
    await loadAllData();
    // Update modal title
    document.getElementById('detailTitle').textContent = newName || s.email;
  } catch(err) {
    feedback.textContent = 'Error: ' + (err.message || 'Could not save.');
    feedback.className = 'admin-feedback admin-feedback-err';
  }
  btn.disabled = false;
  btn.textContent = 'Save Changes';
}

// ============ Reset Actions ============
async function resetStudentQuizzes() {
  if (currentDetailIdx < 0) return;
  var s = allStudents[currentDetailIdx];
  if (!confirm('Reset ALL quiz results for ' + (s.full_name || s.email) + '? They will need to redo every quiz.')) return;

  var btn = document.getElementById('resetQuizBtn');
  btn.disabled = true;
  btn.textContent = 'Resetting...';
  try {
    await adminResetQuizzes(s.id);
    await loadAllData();
    showDetail(currentDetailIdx);
  } catch(err) {
    alert('Error: ' + (err.message || 'Could not reset quizzes.'));
  }
  btn.disabled = false;
  btn.textContent = 'Reset All Quizzes';
}

async function resetStudentProgress() {
  if (currentDetailIdx < 0) return;
  var s = allStudents[currentDetailIdx];
  if (!confirm('Reset ALL progress for ' + (s.full_name || s.email) + '? This clears quizzes AND completed modules. They start from zero.')) return;

  var btn = document.getElementById('resetProgressBtn');
  btn.disabled = true;
  btn.textContent = 'Resetting...';
  try {
    await adminResetProgress(s.id);
    await loadAllData();
    showDetail(currentDetailIdx);
  } catch(err) {
    alert('Error: ' + (err.message || 'Could not reset progress.'));
  }
  btn.disabled = false;
  btn.textContent = 'Reset All Progress';
}

// ============ Generate Invite Code ============
async function generateCode() {
  var btn = document.getElementById('genBtn');
  var msgEl = document.getElementById('newCodeMsg');
  btn.disabled = true;
  btn.textContent = 'Generating...';
  try {
    var code = await adminGenerateInvite();
    msgEl.innerHTML = 'New code: <code class="admin-code-highlight">' + code + '</code> &mdash; Share this with the new student.';
    msgEl.style.display = 'block';
    allInvites = await adminGetInviteCodes();
    renderInvites();
    renderStats();
  } catch(err) {
    msgEl.textContent = 'Error: ' + (err.message || 'Could not generate code.');
    msgEl.style.display = 'block';
  }
  btn.disabled = false;
  btn.textContent = 'Generate New Code';
}
</script>
</body>
</html>
